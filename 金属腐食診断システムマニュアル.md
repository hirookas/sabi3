# 金属腐食診断システムマニュアル

最終更新: 2025-08-23

---

## 1. 概要
本アプリは、**金属腐食診断**を目的とした Streamlit 製のビジュアル検査ツールです。1枚の画像ごとに、

- **画像プレビュー**（腐食予測時は赤枠表示）
- **分類スコア**（3クラスの softmax 確率）
- **確信度**（※ **ピーククラス**＝softmax 最大のクラスに対する、校正後または raw 確率）
- **回帰値**（劣化度スコア/腐食面積率 0–1）

を並べて表示します。なお、**corrosion がピークでない場合**は、回帰バーに**グレーのハッチ**を適用して注意喚起します。

---

## 2. 動作環境
- OS: Windows / macOS / Linux
- Python: 3.9 以降推奨
- 主要ライブラリ:
  - streamlit, torch, torchvision, pillow, matplotlib, numpy
  - （任意）joblib（Isotonic 校正を使う場合）
- フォント（任意）: Noto Sans CJK JP / IPAexGothic など（日本語表示の文字化け対策）

### インストール例
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install streamlit torch torchvision pillow matplotlib numpy joblib
```

---

## 3. 実行方法
```bash
streamlit run app.py
```
ブラウザが自動で開かない場合は、表示されたローカル URL にアクセスしてください。

---

## 4. ディレクトリ/ファイルの準備
### 4.1 モデル
- 拡張子: `.pth` / `.pt` / `.bin`
- **CustomResNet18** の出力に合わせた **3 クラス分類**（`Corrosion`, `no-Corrosion`, `base`）と**回帰**（1 出力, 0–1）を想定
- UI の「モデルディレクトリ」「モデルファイル」から選択

> **注意**: state_dict のキー/形状が合わない場合は読み込みエラーになります。学習時と同一のヘッド（`fc_class`, `fc_regression`）構成で書き出してください。

### 4.2 画像
- 拡張子: `.png`, `.jpg`, `.jpeg`, `.bmp`, `.gif`, `.webp`
- UI の「画像フォルダ」から選択（既定で**フォルダ内の全画像**が選択されます）

### 4.3 校正ファイル（任意）
**ピーククラスごと**の確信度校正に使用。存在しない場合は raw（softmax）を使用します。

- **Platt**（ロジスティック）: `platt_{class}.json`
  - 例: `platt_corrosion.json`, `platt_no-corrosion.json`, `platt_new.json`
  - フォーマット:
    ```json
    {"A": 1.234, "B": -0.567}
    ```
- **Isotonic**: `isotonic_{class}.pkl`（`joblib` で保存）
  - 例: `isotonic_corrosion.pkl`, `isotonic_no-corrosion.pkl`, `isotonic_new.pkl`
- 互換名: 第3クラスは内部 `base` ですが、本アプリでは表示名を **"new"** にしています。`*_base.*` も自動で探索します。

> **クラス名対応**
> - 内部: `Corrosion`, `no-Corrosion`, `base`
> - 表示/校正キー: `corrosion`, `no-corrosion`, `new`（`base` も可）

---

## 5. 画面の見方 & 操作
### 5.1 サイドバー
- **タイル高さ（px）**: 画像/グラフの正方表示サイズ
- **画像の縮小率**: 画像周囲の余白（小さくするほど余白増）
- **回帰の意味**: `劣化度スコア (0-1)` / `腐食面積率 (0-1)`（表記のみ変更）
- **確信度の校正（ピーククラス）**:
  - `オフ`: ピーククラスの softmax をそのまま表示
  - `自動(ファイル検出)`: Isotonic 優先 → Platt → raw
  - `Platt`: そのクラスの `platt_*.json` を使用
  - `Isotonic`: そのクラスの `isotonic_*.pkl` を使用
- **レイアウト**: `4列（画像+3図）` / `2列（画像+図）`

### 5.2 中央エリア
- **画像**: 予測ラベルが `corrosion` のとき**赤枠**表示。
- **分類スコア**: `corrosion → no-corrosion → new` の順で棒グラフ表示（softmax）
- **確信度**: **ピーククラス**の確率（校正後/生）。タイトルに校正方式とクラスが表示されます。
- **回帰**: 劣化度/面積率（0–1）。**corrosion がピークでない**場合は**グレーハッチ**表示。

---

## 6. 確信度（校正）の仕組み
- 本アプリの「確信度」は、**softmax 最大のクラス**について、選択された方法で**クラス別に校正**した結果を表示します。
- `自動(ファイル検出)` は、**Isotonic** が見つかればそれを、なければ **Platt**、さらに無ければ **raw** を採用します。
- 校正ファイルが不整合（別チェックポイント/前処理違いなど）の場合、期待した挙動にならないことがあります。同一条件の検証セットで作成した校正器の使用を推奨します。

---

## 7. 推奨ワークフロー（品質管理）
1. 学習 → 検証セットで **Platt/Isotonic の校正器を作成**（クラス別）。
2. **信頼性図（Reliability Diagram）** と **ECE** を算出して、校正前後の差を確認。
3. 本アプリに校正器を配置し、`自動(ファイル検出)` で実表示を確認。
4. 分布シフトが疑われる画像（照明/スケール/素材違いなど）で挙動確認。

---

## 8. トラブルシューティング
### 8.1 モデルが読み込めない
- エラー例: state_dict mismatch / shape mismatch
  - **原因**: 学習時と出力ヘッド構成（`fc_class`, `fc_regression`）やクラス数が違う
  - **対処**: 同一構成の学習済み重みを使用/再学習

### 8.2 校正が効かない/落ちる
- `Isotonic` 選択時にエラー → `pip install joblib` を確認
- 校正ファイルが見つからない → ファイル名と置き場所（モデルディレクトリ）を確認
- 自動モードで raw になっている → 対応ファイルの不足/命名違い（`new` と `base`）

### 8.3 文字化け
- 日本語フォントを OS にインストールし、`_JP_FONT_CANDIDATES` に追加してください。

### 8.4 Pillow の LANCZOS で AttributeError
- 新しい Pillow では `Image.Resampling.LANCZOS` が必要な場合があります。コードを置換してください。

### 8.5 処理が重い/落ちる
- 画像点数を減らす / タイルサイズを下げる
- 画像をあらかじめ 224×224 に近いサイズに縮小
- GPU 推論に切り替える（※ カスタマイズ節参照）

---

## 9. カスタマイズのヒント
### 9.1 第3クラス名の変更
- 現在は `base` → 表示名 `new` にしています。`to_display_name()` を `"other"` などに変更可能。
- 校正ファイル名も合わせて変更（`platt_other.json` など）するか、互換の `*_base.*` を利用。

### 9.2 ハッチ条件/模様の変更
- 条件: 現在は「**corrosion がピークでない**」で適用。閾値付き（例: `p_conf < 0.6`）に変更も可能。
- 模様: `////`, `\\`, `xx`, `..` などに変更可能。濃さは `hatch_facecolor` を調整。

### 9.3 レイアウトの調整
- 2列/4列のほか、画像の下に 3 図を縦積みにするなどレイアウトの追加も可能。

### 9.4 GPU 推論
- 既定は CPU (`map_location="cpu"`)。GPU を使う場合は、モデル/テンソルを `cuda()` に移し、前処理/推論も GPU に合わせて調整してください。

---

## 10. よくある質問（FAQ）
**Q. 分類スコアと確信度の違いは？**  
A. 分類スコアは softmax の**相対確率**、確信度はピーククラスの**校正後（または raw）の絶対確率**です。

**Q. 確信度が低くなるのはなぜ？**  
A. 校正器（Platt/Isotonic）が、過信気味のスコアを検証データに合わせて下げているためです。分布シフトや校正器の適用ミスマッチでも起きます。

**Q. 画像と棒グラフが重なる/崩れる**  
A. `use_container_width=True` を使用しています。横幅が狭い場合はレイアウトを 2 列に変更し、タイル高さを下げてください。

**Q. どのくらいの画像点数まで表示できますか？**  
A. 環境依存です。まずは 50 枚程度から確認し、処理が重くなるようなら画像数やサイズを調整してください。

---

## 11. デバッグ表示（任意機能の例）
```python
with st.expander(f"Debug: {image_file}"):
    st.write({
        "peak_class": top_display,
        "softmax": {lbl: float(val) for lbl, val in zip(ordered_labels_display, ordered_scores)},
        "p_raw_peak": float(p_raw_top),
        "p_conf_after_calib": float(p_conf),
        "calib_mode": calib_choice,
    })
```

---

## 12. ライセンス/注意事項
- 使用する学習済みモデルや画像データの権利/ライセンスは各自確認してください。
- 本アプリは参考実装です。実運用時は品質評価と監査ログ等の付与を推奨します。

---

### 付録A: 校正ファイルの例
**Platt（JSON）**
```json
{"A": 2.1375, "B": -1.0462}
```
**Isotonic（joblib）**
```python
from sklearn.isotonic import IsotonicRegression
import joblib
iso = IsotonicRegression(out_of_bounds='clip').fit(probs, labels)
joblib.dump(iso, 'isotonic_corrosion.pkl')
```

以上。必要に応じて PDF 化/画像入りの手順書版も作成できます。

